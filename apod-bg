#!/bin/bash

install_timer() {
  local script_path=$(realpath "$0")
  local service_name="apod-bg"
  local config_dir="$HOME/.config/systemd/user"

  if [ ! -d "$config_dir" ]; then
    mkdir -p "$config_dir"
  fi

  # create service file
  cat >"$config_dir/$service_name.service" <<'EOF'
[Unit]
Description=NASA APOD Background Updater

[Service]
Type=oneshot
ExecStart=/bin/bash SCRIPT_PATH_PLACEHOLDER
EOF

  # replace placeholder with actual script path
  sed -i "s|SCRIPT_PATH_PLACEHOLDER|$script_path|g" "$config_dir/$service_name.service"

  # APOD updates at 05:00 UTC, we want 1 hour later = 06:00 UTC
  # convert 06:00 UTC to local time
  local local_time=$(date -d '06:00 UTC today' +%H:%M)

  # create timer file
  cat >"$config_dir/$service_name.timer" <<'EOF'
[Unit]
Description=Daily NASA APOD Background Update Timer

[Timer]
OnCalendar=LOCAL_TIME_PLACEHOLDER
Persistent=true
RandomizedDelaySec=300

[Install]
WantedBy=timers.target
EOF

  sed -i "s/LOCAL_TIME_PLACEHOLDER/$local_time/g" "$config_dir/$service_name.timer"

  # create resume service; runs when waking from sleep
  cat >"$config_dir/$service_name-resume.service" <<'EOF'
[Unit]
Description=NASA APOD Background Updater (on resume from sleep)
After=suspend.target

[Service]
Type=oneshot
ExecStart=SCRIPT_PATH_PLACEHOLDER
# Add a small delay to ensure network is up
ExecStartPre=/bin/sleep 30

[Install]
WantedBy=suspend.target
EOF

  sed -i "s|SCRIPT_PATH_PLACEHOLDER|$script_path|g" "$config_dir/$service_name-resume.service"

  # reload systemd and enable timer
  systemctl --user daemon-reload
  systemctl --user enable "$service_name.timer"
  systemctl --user start "$service_name.timer"
  systemctl --user enable "$service_name-resume.service"

  echo "Systemd timer installed successfully!"
  echo ""
  echo "  - Daily at $local_time (1 hour after NASA updates at 05:00 UTC)"
  echo "  - When waking from sleep/suspend (if scheduled time was missed)"
  echo "  - On boot (if laptop was off during scheduled time)"
  echo ""
  echo "Useful commands:"
  echo "  Check timer status:    systemctl --user status $service_name.timer"
  echo "  Check service status:  systemctl --user status $service_name.service"
  echo "  Check resume service:  systemctl --user status $service_name-resume.service"
  echo "  View timer schedule:   systemctl --user list-timers"
  echo "  Run manually now:      systemctl --user start $service_name.service"
  echo "  View logs:             journalctl --user -u $service_name.service"
  echo "  Disable timer:         systemctl --user disable $service_name.timer"
  echo "  Stop timer:            systemctl --user stop $service_name.timer"
}

# check if --install-timer flag is passed
if [[ "$1" == "--install-timer" ]]; then
  install_timer
  exit 0
fi

# display information regarding the script
if [[ "$1" == "--info" ]]; then
  echo "apod-bg service:"
  echo "  - Daily at $local_time (1 hour after NASA updates at 05:00 UTC)"
  echo "  - When waking from sleep/suspend (if scheduled time was missed)"
  echo "  - On boot (if laptop was off during scheduled time)"
  echo ""
  echo "systemctl commands:"
  echo "  Check timer status:    systemctl --user status $service_name.timer"
  echo "  Check service status:  systemctl --user status $service_name.service"
  echo "  Check resume service:  systemctl --user status $service_name-resume.service"
  echo "  View timer schedule:   systemctl --user list-timers"
  echo "  Run manually now:      systemctl --user start $service_name.service"
  echo "  View logs:             journalctl --user -u $service_name.service"
  echo "  Disable timer:         systemctl --user disable $service_name.timer"
  echo "  Stop timer:            systemctl --user stop $service_name.timer"
  exit 0
fi

api_key="DEMO_KEY"
path="$HOME/apod-images" #use absolute path
new_img_name='today-nasa-apod.jpg'
placholder_bg_path="$HOME/apod-images/2025-02-05.png"

if [ ! -d "$path" ]; then
  mkdir -p "$path"
fi

# init placeholder background image
init_placeholder_bg() {
  local placeholder_url=$(curl -s "https://api.nasa.gov/planetary/apod?api_key=$api_key&date=2025-02-05" | jq -r '.hdurl // .url')
  if [[ -n "$placeholder_url" && "$placeholder_url" != "null" ]]; then
    curl -s -o "$placholder_bg_path" "$placeholder_url"
  else
    echo "Warning: Could not download placeholder image" >&2
  fi
}

if [ ! -f "$placholder_bg_path" ]; then
  init_placeholder_bg
fi

dconf write /org/gnome/desktop/background/picture-options "'scaled'"

# fetch apod
json_resp=$(curl -s "https://api.nasa.gov/planetary/apod?api_key=$api_key")

apod_date=$(jq -r '.date' <<<"$json_resp")
today_date=$(date +%Y-%m-%d)

# if the api hasn't updated yet (still showing old state), keep current wallpaper
if [[ "$apod_date" != "$today_date" ]]; then
  if [ -f "$path/$new_img_name" ]; then
    echo "API not updated yet; keep current wallpaper"
  else
    echo "API not updated yet and no previous image found; using placeholder as wallpaper"
    dconf write /org/gnome/desktop/background/picture-uri-dark "'file://$placholder_bg_path'"
    dconf write /org/gnome/desktop/background/picture-uri "'file://$placholder_bg_path'"
  fi
  exit 0
fi

# if there's error, make $err empty
err=$(jq -r '.error // empty' <<<"$json_resp")
if [[ -n "$err" ]]; then
  echo "API error while fetching apod; using placeholder"
  dconf write /org/gnome/desktop/background/picture-uri-dark "'file://$placholder_bg_path'"
  dconf write /org/gnome/desktop/background/picture-uri "'file://$placholder_bg_path'"
  exit 1
fi

media_type=$(jq -r '.media_type' <<<"$json_resp")
if [[ "$media_type" != "image" ]]; then
  echo "media type is not image; using placeholder"
  dconf write /org/gnome/desktop/background/picture-uri-dark "'file://$placholder_bg_path'"
  dconf write /org/gnome/desktop/background/picture-uri "'file://$placholder_bg_path'"
  exit 0
fi

img_url=$(jq -r '.hdurl // .url' <<<"$json_resp")

if curl -s -o "$path/$new_img_name" "$img_url"; then
  dconf write /org/gnome/desktop/background/picture-uri-dark "'file://$(realpath "$path/$new_img_name")'"
  dconf write /org/gnome/desktop/background/picture-uri "'file://$(realpath "$path/$new_img_name")'"
  echo "âœ” wallpaper is successfully updated"
else
  echo "failed to download image; using placeholder"
  dconf write /org/gnome/desktop/background/picture-uri-dark "'file://$placholder_bg_path'"
  dconf write /org/gnome/desktop/background/picture-uri "'file://$placholder_bg_path'"
  exit 1
fi
